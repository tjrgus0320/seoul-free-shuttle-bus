<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„œìš¸ ë¬´ë£Œ ì…”í‹€ë²„ìŠ¤ ë…¸ì„ ë„</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #0066cc 0%, #004999 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header p {
      margin-top: 8px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .update-info {
      margin-top: 5px;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    #tabs {
      display: flex;
      flex-wrap: wrap;
      padding: 15px;
      gap: 8px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    #tabs button {
      padding: 8px 16px;
      border: 2px solid #0066cc;
      background: white;
      color: #0066cc;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    #tabs button:hover {
      background: #e6f0ff;
    }

    #tabs button.active {
      background: #0066cc;
      color: white;
    }

    .main-container {
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 768px) {
      .main-container {
        flex-direction: row;
        height: calc(100vh - 160px);
      }
    }

    #map {
      height: 50vh;
      width: 100%;
    }

    @media (min-width: 768px) {
      #map {
        height: 100%;
        flex: 1;
      }
    }

    #info {
      padding: 20px;
      background: white;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      #info {
        width: 380px;
        border-left: 1px solid #e0e0e0;
      }
    }

    #info h3 {
      font-size: 1.3rem;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #0066cc;
    }

    .route-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #0066cc;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .route-card:hover {
      background: #e6f0ff;
      transform: translateX(5px);
    }

    .route-card.active {
      background: #e6f0ff;
      border-left-color: #ff6b00;
    }

    .route-card h4 {
      font-size: 1.1rem;
      color: #0066cc;
      margin-bottom: 10px;
    }

    .route-info {
      display: flex;
      gap: 20px;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 10px;
    }

    .route-info span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stops-list {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ddd;
    }

    .stops-list h5 {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    .stop-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 0;
      font-size: 0.9rem;
      color: #444;
    }

    .stop-dot {
      width: 10px;
      height: 10px;
      background: #0066cc;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .stop-item:first-child .stop-dot {
      background: #00cc66;
    }

    .stop-item:last-child .stop-dot {
      background: #ff6b00;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #666;
    }

    .error-message {
      background: #ffe6e6;
      color: #cc0000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.start { background: #00cc66; }
    .legend-dot.end { background: #ff6b00; }
    .legend-dot.stop { background: #0066cc; }

    footer {
      background: #333;
      color: #aaa;
      padding: 15px 20px;
      text-align: center;
      font-size: 0.8rem;
    }

    footer a {
      color: #66b3ff;
      text-decoration: none;
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸšŒ ì„œìš¸ ë¬´ë£Œ ì…”í‹€ë²„ìŠ¤ ë…¸ì„  ì•ˆë‚´</h1>
  <p>ì„œìš¸ì‹œ ìì¹˜êµ¬ë³„ ë¬´ë£Œ ì…”í‹€ë²„ìŠ¤ ìš´í–‰ ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
  <div class="update-info" id="updateInfo">ë°ì´í„° ë¡œë”© ì¤‘...</div>
</header>

<div id="tabs">
  <div class="loading">ìì¹˜êµ¬ ëª©ë¡ ë¡œë”© ì¤‘...</div>
</div>

<div class="main-container">
  <div id="map"></div>
  <div id="info">
    <div class="loading">ë…¸ì„  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
</div>

<footer>
  <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” ì„œìš¸ì‹œ ê³µì‹ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
  <p style="margin-top: 5px;">ë¬¸ì˜ ë° ì˜¤ë¥˜ ì‹ ê³ : <a href="#">shuttle@example.com</a></p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ì „ì—­ ë³€ìˆ˜
let map;
let layers = [];
let shuttleData = null;
let activeDistrict = null;
let activeRoute = null;

// ìƒ‰ìƒ íŒ”ë ˆíŠ¸
const COLORS = [
  '#0066cc', '#cc3300', '#009933', '#9933cc',
  '#ff6600', '#0099cc', '#cc0066', '#669900'
];

// ì§€ë„ ì´ˆê¸°í™”
function initMap() {
  map = L.map('map').setView([37.5665, 126.9780], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ë²”ë¡€ ì¶”ê°€
  const legend = L.control({ position: 'bottomleft' });
  legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-item"><div class="legend-dot start"></div> ì¶œë°œì§€</div>
      <div class="legend-item"><div class="legend-dot stop"></div> ì •ë¥˜ì¥</div>
      <div class="legend-item"><div class="legend-dot end"></div> ì¢…ì </div>
    `;
    return div;
  };
  legend.addTo(map);
}

// ë°ì´í„° ë¡œë“œ
async function loadData() {
  try {
    const response = await fetch('shuttle_routes.json');
    if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

    shuttleData = await response.json();

    // ì—…ë°ì´íŠ¸ ì •ë³´ í‘œì‹œ
    document.getElementById('updateInfo').textContent =
      `ìµœì¢… ì—…ë°ì´íŠ¸: ${shuttleData.updated_at} | ì¶œì²˜: ${shuttleData.source}`;

    // íƒ­ ìƒì„±
    renderTabs();

    // ì²« ë²ˆì§¸ ìì¹˜êµ¬ í‘œì‹œ
    if (shuttleData.districts.length > 0) {
      showDistrict(shuttleData.districts[0]);
    }
  } catch (error) {
    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    document.getElementById('tabs').innerHTML =
      '<div class="error-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>';
  }
}

// íƒ­ ë Œë”ë§
function renderTabs() {
  const tabsContainer = document.getElementById('tabs');
  tabsContainer.innerHTML = '';

  shuttleData.districts.forEach((district) => {
    const btn = document.createElement('button');
    btn.textContent = district.district;
    btn.onclick = () => showDistrict(district);
    btn.dataset.district = district.district;
    tabsContainer.appendChild(btn);
  });
}

// ìì¹˜êµ¬ í‘œì‹œ
function showDistrict(district) {
  activeDistrict = district;
  activeRoute = null;

  // íƒ­ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
  document.querySelectorAll('#tabs button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.district === district.district);
  });

  // ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸
  renderRouteInfo(district);

  // ì§€ë„ì— ëª¨ë“  ë…¸ì„  í‘œì‹œ
  showAllRoutesOnMap(district);
}

// ë…¸ì„  ì •ë³´ ë Œë”ë§
function renderRouteInfo(district) {
  const infoContainer = document.getElementById('info');

  let html = `<h3>${district.district} ì…”í‹€ë²„ìŠ¤</h3>`;

  district.routes.forEach((route, idx) => {
    const isActive = activeRoute === route.name;
    html += `
      <div class="route-card ${isActive ? 'active' : ''}"
           onclick="focusRoute('${district.district}', ${idx})">
        <h4>${route.name}</h4>
        <div class="route-info">
          <span>â° ${route.hours}</span>
          <span>ğŸ”„ ${route.interval}</span>
        </div>
        <div class="stops-list">
          <h5>ì •ë¥˜ì¥ (${route.stops.length}ê°œ)</h5>
          ${route.stops.map((stop, i) => `
            <div class="stop-item">
              <div class="stop-dot"></div>
              ${stop.name}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });

  infoContainer.innerHTML = html;
}

// ì§€ë„ì— ëª¨ë“  ë…¸ì„  í‘œì‹œ
function showAllRoutesOnMap(district) {
  // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
  layers.forEach(layer => map.removeLayer(layer));
  layers = [];

  const bounds = L.latLngBounds();

  district.routes.forEach((route, routeIdx) => {
    const color = COLORS[routeIdx % COLORS.length];
    const coords = route.stops.map(s => [s.lat, s.lng]);

    // ì •ë¥˜ì¥ ë§ˆì»¤
    route.stops.forEach((stop, stopIdx) => {
      let markerColor = color;
      let iconSize = [10, 10];

      if (stopIdx === 0) {
        markerColor = '#00cc66'; // ì¶œë°œì§€
        iconSize = [14, 14];
      } else if (stopIdx === route.stops.length - 1) {
        markerColor = '#ff6b00'; // ì¢…ì 
        iconSize = [14, 14];
      }

      const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: ${iconSize[0]}px;
          height: ${iconSize[1]}px;
          background: ${markerColor};
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: iconSize,
        iconAnchor: [iconSize[0]/2, iconSize[1]/2]
      });

      const marker = L.marker([stop.lat, stop.lng], { icon })
        .addTo(map)
        .bindPopup(`
          <strong>${stop.name}</strong><br>
          <small>${route.name}</small>
        `);

      layers.push(marker);
      bounds.extend([stop.lat, stop.lng]);
    });

    // ë…¸ì„  ë¼ì¸
    const polyline = L.polyline(coords, {
      color: color,
      weight: 4,
      opacity: 0.8
    }).addTo(map);

    layers.push(polyline);
  });

  // ì§€ë„ ë²”ìœ„ ì¡°ì •
  if (bounds.isValid()) {
    map.fitBounds(bounds, { padding: [50, 50] });
  }
}

// íŠ¹ì • ë…¸ì„  í¬ì»¤ìŠ¤
function focusRoute(districtName, routeIdx) {
  const district = shuttleData.districts.find(d => d.district === districtName);
  if (!district) return;

  const route = district.routes[routeIdx];
  activeRoute = route.name;

  // ì¹´ë“œ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.route-card').forEach((card, idx) => {
    card.classList.toggle('active', idx === routeIdx);
  });

  // í•´ë‹¹ ë…¸ì„ ìœ¼ë¡œ ì§€ë„ ì´ë™
  const coords = route.stops.map(s => [s.lat, s.lng]);
  const bounds = L.latLngBounds(coords);
  map.fitBounds(bounds, { padding: [80, 80] });
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  loadData();
});
</script>

</body>
</html>
