<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0066cc">
  <meta name="description" content="ÏÑúÏö∏Ïãú ÏûêÏπòÍµ¨Î≥Ñ Î¨¥Î£å ÏÖîÌãÄÎ≤ÑÏä§ ÎÖ∏ÏÑ† ÏïàÎÇ¥">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ÏÑúÏö∏ Î¨¥Î£å ÏÖîÌãÄÎ≤ÑÏä§ ÎÖ∏ÏÑ†ÎèÑ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Malgun Gothic',sans-serif;background:#f5f5f5;min-height:100vh;overscroll-behavior:none}
    header{background:linear-gradient(135deg,#0066cc 0%,#004999 100%);color:white;padding:16px;padding-top:max(16px,env(safe-area-inset-top));box-shadow:0 2px 10px rgba(0,0,0,0.2);position:relative;z-index:100}
    header h1{font-size:1.25rem;font-weight:600;display:flex;align-items:center;gap:8px}
    header p{margin-top:6px;font-size:0.8rem;opacity:0.9}
    .update-info{margin-top:4px;font-size:0.7rem;opacity:0.7}
    #tabs{display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;padding:12px;gap:8px;background:white;border-bottom:1px solid #e0e0e0;position:sticky;top:0;z-index:1000;scrollbar-width:none}
    #tabs::-webkit-scrollbar{display:none}
    #tabs button{flex-shrink:0;padding:10px 18px;border:2px solid #0066cc;background:white;color:#0066cc;border-radius:25px;cursor:pointer;font-size:0.9rem;font-weight:500;transition:all 0.2s ease;scroll-snap-align:start;min-height:44px}
    #tabs button:active{transform:scale(0.95)}
    #tabs button.active{background:#0066cc;color:white;box-shadow:0 2px 8px rgba(0,102,204,0.4)}
    .main-container{display:flex;flex-direction:column;height:calc(100vh - 120px);height:calc(100dvh - 120px)}
    #map{flex:1;min-height:40vh;width:100%;z-index:1;position:relative}
    #info-panel{background:white;border-radius:20px 20px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,0.15);position:relative;z-index:10;max-height:45vh;overflow:hidden;transition:max-height 0.3s ease}
    #info-panel.expanded{max-height:70vh}
    .panel-handle{width:40px;height:4px;background:#ddd;border-radius:2px;margin:12px auto 8px;cursor:grab}
    #info{padding:0 16px 16px;overflow-y:auto;max-height:calc(45vh - 30px);-webkit-overflow-scrolling:touch}
    #info-panel.expanded #info{max-height:calc(70vh - 30px)}
    #info h3{font-size:1.2rem;color:#333;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #0066cc;position:sticky;top:0;background:white}
    .route-card{background:#f8f9fa;border-radius:12px;padding:14px;margin-bottom:12px;border-left:4px solid #0066cc;cursor:pointer;transition:all 0.2s ease;-webkit-user-select:none;user-select:none}
    .route-card:active{transform:scale(0.98);background:#e6f0ff}
    .route-card.active{background:#e6f0ff;border-left-color:#ff6b00}
    .route-card h4{font-size:1rem;color:#0066cc;margin-bottom:8px}
    .route-info{display:flex;flex-wrap:wrap;gap:12px;font-size:0.85rem;color:#666;margin-bottom:8px}
    .route-info span{display:flex;align-items:center;gap:4px}
    .stops-toggle{display:flex;align-items:center;justify-content:space-between;padding:8px 0;font-size:0.85rem;color:#666;border-top:1px dashed #ddd;margin-top:8px}
    .stops-toggle-btn{background:none;border:none;color:#0066cc;font-size:0.85rem;cursor:pointer;padding:4px 8px;min-height:32px}
    .stops-list{display:none;padding-top:8px}
    .stops-list.show{display:block}
    .stop-item{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:0.85rem;color:#444}
    .stop-dot{width:10px;height:10px;background:#0066cc;border-radius:50%;flex-shrink:0}
    .stop-item:first-child .stop-dot{background:#00cc66}
    .stop-item:last-child .stop-dot{background:#ff6b00}
    .loading{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px;color:#666;gap:12px}
    .loading-spinner{width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#0066cc;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-message{background:#ffe6e6;color:#cc0000;padding:20px;border-radius:12px;text-align:center;margin:16px}
    .locate-btn{position:absolute;bottom:20px;right:20px;width:48px;height:48px;background:white;border:none;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,0.2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.5rem;z-index:1000;transition:transform 0.2s}
    .locate-btn:active{transform:scale(0.9)}
    .legend{position:absolute;bottom:80px;left:12px;background:white;padding:10px 14px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.15);z-index:1000;font-size:0.75rem}
    .legend-item{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .legend-dot.start{background:#00cc66}
    .legend-dot.end{background:#ff6b00}
    .legend-dot.stop{background:#0066cc}
    footer{background:#333;color:#aaa;padding:16px;padding-bottom:max(16px,env(safe-area-inset-bottom));text-align:center;font-size:0.75rem}
    footer a{color:#66b3ff;text-decoration:none}
    @media(min-width:768px){header h1{font-size:1.5rem}header p{font-size:0.9rem}.main-container{flex-direction:row;height:calc(100vh - 140px)}#map{flex:1;min-height:auto}#info-panel{width:400px;max-height:100%;border-radius:0;box-shadow:-4px 0 20px rgba(0,0,0,0.1)}#info-panel.expanded{max-height:100%}.panel-handle{display:none}#info{max-height:calc(100vh - 200px);padding:20px}#info-panel.expanded #info{max-height:calc(100vh - 200px)}.route-card{padding:16px}.route-card:hover{background:#e6f0ff;transform:translateX(4px)}.stops-list{display:block}.stops-toggle-btn{display:none}}
    @media(prefers-color-scheme:dark){body{background:#1a1a1a}header{background:linear-gradient(135deg,#004999 0%,#003366 100%)}#tabs{background:#2a2a2a;border-color:#444}#tabs button{background:#2a2a2a;border-color:#4a90cc;color:#4a90cc}#tabs button.active{background:#4a90cc;color:white}#info-panel{background:#2a2a2a}#info h3{color:#fff;background:#2a2a2a}.route-card{background:#333}.route-card h4{color:#4a90cc}.route-info{color:#aaa}.stop-item{color:#ccc}.legend{background:#2a2a2a;color:#ccc}.locate-btn{background:#2a2a2a;color:#fff}}
  </style>
</head>
<body>
<header>
  <h1>üöå ÏÑúÏö∏ Î¨¥Î£å ÏÖîÌãÄÎ≤ÑÏä§</h1>
  <p>ÏÑúÏö∏Ïãú ÏûêÏπòÍµ¨Î≥Ñ Î¨¥Î£å ÏÖîÌãÄÎ≤ÑÏä§ Ïö¥Ìñâ Ï†ïÎ≥¥</p>
  <div class="update-info" id="updateInfo">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
</header>
<div id="tabs"><div class="loading"><div class="loading-spinner"></div></div></div>
<div class="main-container">
  <div id="map"><button class="locate-btn" onclick="locateUser()" title="ÌòÑÏû¨ ÏúÑÏπò">üìç</button></div>
  <div id="info-panel">
    <div class="panel-handle" id="panelHandle"></div>
    <div id="info"><div class="loading"><div class="loading-spinner"></div><span>ÎÖ∏ÏÑ† Ï†ïÎ≥¥ Î°úÎî© Ï§ë...</span></div></div>
  </div>
</div>
<footer>
  <p>ÏÑúÏö∏Ïãú Í≥µÏãù Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò | ÎπÑÏòÅÎ¶¨ Í≥µÏùµ ÏÑúÎπÑÏä§</p>
  <p style="margin-top:8px;"><a href="https://github.com/user/seoul-shuttle-bus" target="_blank">GitHub</a> | <a href="mailto:shuttle@example.com">Ïò§Î•ò Ïã†Í≥†</a></p>
</footer>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map,layers=[],shuttleData=null,activeDistrict=null,activeRoute=null,userMarker=null;
const COLORS=['#0066cc','#cc3300','#009933','#9933cc','#ff6600','#0099cc','#cc0066','#669900'];

function initMap(){
  map=L.map('map',{zoomControl:false,attributionControl:false}).setView([37.5665,126.9780],11);
  L.control.zoom({position:'topright'}).addTo(map);
  L.control.attribution({position:'bottomright'}).addAttribution('OpenStreetMap').addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const legend=L.control({position:'bottomleft'});
  legend.onAdd=function(){
    const div=L.DomUtil.create('div','legend');
    div.innerHTML='<div class="legend-item"><div class="legend-dot start"></div> Ï∂úÎ∞ú</div><div class="legend-item"><div class="legend-dot stop"></div> Ï†ïÎ•òÏû•</div><div class="legend-item"><div class="legend-dot end"></div> Ï¢ÖÏ†ê</div>';
    return div;
  };
  legend.addTo(map);
}

function locateUser(){
  if(!navigator.geolocation)return alert('ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
  navigator.geolocation.getCurrentPosition((pos)=>{
    const{latitude,longitude}=pos.coords;
    if(userMarker)map.removeLayer(userMarker);
    userMarker=L.circleMarker([latitude,longitude],{radius:10,fillColor:'#4285f4',fillOpacity:1,color:'white',weight:3}).addTo(map).bindPopup('ÌòÑÏû¨ ÏúÑÏπò');
    map.setView([latitude,longitude],14);
    findNearestDistrict(latitude,longitude);
  },()=>alert('ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'),{enableHighAccuracy:true,timeout:10000});
}

function findNearestDistrict(lat,lng){
  if(!shuttleData)return;
  let nearest=null,minDist=Infinity;
  shuttleData.districts.forEach(district=>{
    district.routes.forEach(route=>{
      route.stops.forEach(stop=>{
        const dist=Math.sqrt(Math.pow(stop.lat-lat,2)+Math.pow(stop.lng-lng,2));
        if(dist<minDist){minDist=dist;nearest=district;}
      });
    });
  });
  if(nearest)showDistrict(nearest);
}

async function loadData(){
  try{
    const response=await fetch('shuttle_routes.json');
    if(!response.ok)throw new Error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
    shuttleData=await response.json();
    document.getElementById('updateInfo').textContent='ÏóÖÎç∞Ïù¥Ìä∏: '+shuttleData.updated_at;
    renderTabs();
    if(shuttleData.districts.length>0)showDistrict(shuttleData.districts[0]);
  }catch(error){
    document.getElementById('tabs').innerHTML='<div class="error-message">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®. ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
    document.getElementById('info').innerHTML='<div class="error-message">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</div>';
  }
}

function renderTabs(){
  const tabsContainer=document.getElementById('tabs');
  tabsContainer.innerHTML='';
  shuttleData.districts.forEach((district)=>{
    const btn=document.createElement('button');
    btn.textContent=district.district;
    btn.onclick=()=>showDistrict(district);
    btn.dataset.district=district.district;
    tabsContainer.appendChild(btn);
  });
}

function showDistrict(district){
  activeDistrict=district;
  activeRoute=null;
  document.querySelectorAll('#tabs button').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.district===district.district);
    if(btn.dataset.district===district.district)btn.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
  });
  renderRouteInfo(district);
  showAllRoutesOnMap(district);
}

function renderRouteInfo(district){
  const infoContainer=document.getElementById('info');
  let html='<h3>'+district.district+'</h3>';
  district.routes.forEach((route,idx)=>{
    const isActive=activeRoute===route.name;
    const stopsId='stops-'+idx;
    html+='<div class="route-card '+(isActive?'active':'')+'" onclick="focusRoute(\''+district.district+'\','+idx+')">';
    html+='<h4>'+route.name+'</h4>';
    html+='<div class="route-info"><span>‚è∞ '+(route.hours||'Ï†ïÎ≥¥ ÏóÜÏùå')+'</span><span>üîÑ '+(route.interval||'Ï†ïÎ≥¥ ÏóÜÏùå')+'</span></div>';
    html+='<div class="stops-toggle"><span>Ï†ïÎ•òÏû• '+route.stops.length+'Í∞ú</span>';
    html+='<button class="stops-toggle-btn" onclick="event.stopPropagation();toggleStops(\''+stopsId+'\')">ÌéºÏπòÍ∏∞ ‚ñº</button></div>';
    html+='<div class="stops-list" id="'+stopsId+'">';
    route.stops.forEach(stop=>{html+='<div class="stop-item"><div class="stop-dot"></div>'+stop.name+'</div>';});
    html+='</div></div>';
  });
  infoContainer.innerHTML=html;
}

function toggleStops(stopsId){
  const stopsList=document.getElementById(stopsId);
  const btn=stopsList.previousElementSibling.querySelector('.stops-toggle-btn');
  if(stopsList.classList.contains('show')){
    stopsList.classList.remove('show');
    btn.textContent='ÌéºÏπòÍ∏∞ ‚ñº';
  }else{
    stopsList.classList.add('show');
    btn.textContent='Ï†ëÍ∏∞ ‚ñ≤';
  }
}

function showAllRoutesOnMap(district){
  layers.forEach(layer=>map.removeLayer(layer));
  layers=[];
  const bounds=L.latLngBounds();
  district.routes.forEach((route,routeIdx)=>{
    const color=COLORS[routeIdx%COLORS.length];
    const coords=route.stops.map(s=>[s.lat,s.lng]);
    route.stops.forEach((stop,stopIdx)=>{
      let markerColor=color,iconSize=[10,10];
      if(stopIdx===0){markerColor='#00cc66';iconSize=[14,14];}
      else if(stopIdx===route.stops.length-1){markerColor='#ff6b00';iconSize=[14,14];}
      const icon=L.divIcon({
        className:'custom-marker',
        html:'<div style="width:'+iconSize[0]+'px;height:'+iconSize[1]+'px;background:'+markerColor+';border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
        iconSize:iconSize,
        iconAnchor:[iconSize[0]/2,iconSize[1]/2]
      });
      const marker=L.marker([stop.lat,stop.lng],{icon}).addTo(map).bindPopup('<b>'+stop.name+'</b><br><small>'+route.name+'</small>');
      layers.push(marker);
      bounds.extend([stop.lat,stop.lng]);
    });
    const polyline=L.polyline(coords,{color:color,weight:4,opacity:0.8}).addTo(map);
    layers.push(polyline);
  });
  if(bounds.isValid())map.fitBounds(bounds,{padding:[40,40]});
}

function focusRoute(districtName,routeIdx){
  const district=shuttleData.districts.find(d=>d.district===districtName);
  if(!district)return;
  const route=district.routes[routeIdx];
  activeRoute=route.name;
  document.querySelectorAll('.route-card').forEach((card,idx)=>card.classList.toggle('active',idx===routeIdx));
  const coords=route.stops.map(s=>[s.lat,s.lng]);
  map.fitBounds(L.latLngBounds(coords),{padding:[60,60]});
}

function initPanelSwipe(){
  const panel=document.getElementById('info-panel');
  const handle=document.getElementById('panelHandle');
  let startY=0;
  handle.addEventListener('touchstart',(e)=>{startY=e.touches[0].clientY;});
  handle.addEventListener('touchmove',(e)=>{
    const deltaY=startY-e.touches[0].clientY;
    if(deltaY>50)panel.classList.add('expanded');
    else if(deltaY<-50)panel.classList.remove('expanded');
  });
  handle.addEventListener('click',()=>panel.classList.toggle('expanded'));
}

document.addEventListener('DOMContentLoaded',()=>{initMap();loadData();initPanelSwipe();});
window.addEventListener('resize',()=>setTimeout(()=>map.invalidateSize(),100));
</script>
</body>
</html>
